/*Boost Software License - Version 1.0 - August 17th, 2003*/
/**/
/*Permission is hereby granted, free of charge, to any person or organization*/
/*obtaining a copy of the software and accompanying documentation covered by*/
/*this license (the "Software") to use, reproduce, display, distribute,*/
/*execute, and transmit the Software, and to prepare derivative works of the*/
/*Software, and to permit third-parties to whom the Software is furnished to*/
/*do so, all subject to the following:*/
/**/
/*The copyright notices in the Software and this entire statement, including*/
/*the above license grant, this restriction and the following disclaimer,*/
/*must be included in all copies of the Software, in whole or in part, and*/
/*all derivative works of the Software, unless such copies or derivative*/
/*works are solely in the form of machine-executable object code generated by*/
/*a source language processor.*/
/**/
/*THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR*/
/*IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,*/
/*FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT*/
/*SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE*/
/*FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,*/
/*ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER*/
/*DEALINGS IN THE SOFTWARE.*/

// from https://github.com/shibatch/sleef

#define vfloat  __m128
#define vdouble __m128d
#define vint    __m128i
#define vint2   __m128i
#define vmask   __m128i
#define vopmask __m128i

#define SLEEF_INFINITY __builtin_inf()
#define SLEEF_INFINITYf __builtin_inff()
#define R_LN2f 1.442695040888963407359924681001892137426645954152985934135449406931f
#define L2Uf 0.693145751953125f
#define L2Lf 1.428606765330187045e-06f

#define INLINE __attribute__((always_inline))

// sleef/src/arch/helpersse2.h
static INLINE vint2 sse2_vrint_vi2_vf(vfloat vf) { return _mm_cvtps_epi32(vf); }
static INLINE vfloat sse2_vmul_vf_vf_vf(vfloat x, vfloat y) { return _mm_mul_ps(x, y); }
static INLINE vfloat sse2_vadd_vf_vf_vf(vfloat x, vfloat y) { return _mm_add_ps(x, y); }
static INLINE vfloat sse2_vcast_vf_f(float f) { return _mm_set1_ps(f); }
static INLINE vfloat sse2_vmla_vf_vf_vf_vf(vfloat x, vfloat y, vfloat z) { return sse2_vadd_vf_vf_vf(sse2_vmul_vf_vf_vf(x, y), z); }
static INLINE vmask sse2_vreinterpret_vm_vf(vfloat vf) { return _mm_castps_si128(vf); }
static INLINE vint2 sse2_vcast_vi2_i(int i) { return _mm_set1_epi32(i); }
static INLINE vmask sse2_vcast_vm_vi2(vint2 vi) { return vi; }
static INLINE vfloat sse2_vcast_vf_vi2(vint2 vi) { return _mm_cvtepi32_ps(sse2_vcast_vm_vi2(vi)); }
static INLINE vfloat sse2_vreinterpret_vf_vm(vmask vm) { return _mm_castsi128_ps(vm); }
static INLINE vmask sse2_vandnot_vm_vo32_vm(vmask x, vmask y) { return _mm_andnot_si128(x, y); }
static INLINE vopmask sse2_vlt_vo_vf_vf(vfloat x, vfloat y) { return sse2_vreinterpret_vm_vf(_mm_cmplt_ps(x, y)); }
static INLINE vfloat sse2_vsel_vf_vo_vf_vf(vopmask m, vfloat x, vfloat y) { return _mm_blendv_ps(y, x, _mm_castsi128_ps(m)); }
static INLINE vfloat sse2_vreinterpret_vf_vi2(vint2 vm) { return _mm_castsi128_ps(vm); }

static INLINE vint sse2_vsll_vi_vi_i(vint x, int c) { return _mm_slli_epi32(x, c); }
static INLINE vint2 sse2_vsll_vi2_vi2_i(vint2 x, int c) { return sse2_vsll_vi_vi_i(x, c); }

static INLINE vint sse2_vadd_vi_vi_vi(vint x, vint y) { return _mm_add_epi32(x, y); }
static INLINE vint2 sse2_vadd_vi2_vi2_vi2(vint2 x, vint2 y) { return sse2_vadd_vi_vi_vi(x, y); }

static INLINE vint sse2_vsra_vi_vi_i(vint x, int c) { return _mm_srai_epi32(x, c); }
static INLINE vint2 sse2_vsra_vi2_vi2_i(vint2 x, int c) { return sse2_vsra_vi_vi_i(x, c); }

static INLINE vint sse2_vsub_vi_vi_vi(vint x, vint y) { return _mm_sub_epi32(x, y); }
static INLINE vint2 sse2_vsub_vi2_vi2_vi2(vint2 x, vint2 y) { return sse2_vsub_vi_vi_vi(x, y); }

// sleef/src/libm/sleefsimdsp.c
static INLINE vfloat sse2_vpow2i_vf_vi2(vint2 q) {
  return sse2_vreinterpret_vf_vi2(sse2_vsll_vi2_vi2_i(sse2_vadd_vi2_vi2_vi2(q, sse2_vcast_vi2_i(0x7f)), 23));
}

static INLINE vfloat sse2_vldexp2_vf_vf_vi2(vfloat d, vint2 e) {
  return sse2_vmul_vf_vf_vf(sse2_vmul_vf_vf_vf(d, sse2_vpow2i_vf_vi2(sse2_vsra_vi2_vi2_i(e, 1))), sse2_vpow2i_vf_vi2(sse2_vsub_vi2_vi2_vi2(e, sse2_vsra_vi2_vi2_i(e, 1))));
}

// this is called xexpf in sleef/src/libm/sleefsimdsp.c
// and gets renamed in sleef/build/src/libm/include/renameavx2.h
vfloat Sleef_redux_finz_expf4_u10sse2(vfloat d) {
  vint2 q = sse2_vrint_vi2_vf(sse2_vmul_vf_vf_vf(d, sse2_vcast_vf_f(R_LN2f)));
  vfloat s, u;

  s = sse2_vmla_vf_vf_vf_vf(sse2_vcast_vf_vi2(q), sse2_vcast_vf_f(-L2Uf), d);
  s = sse2_vmla_vf_vf_vf_vf(sse2_vcast_vf_vi2(q), sse2_vcast_vf_f(-L2Lf), s);

  u = sse2_vcast_vf_f(0.000198527617612853646278381);
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.00139304355252534151077271));
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.00833336077630519866943359));
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.0416664853692054748535156));
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.166666671633720397949219));
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.5));

  u = sse2_vadd_vf_vf_vf(sse2_vcast_vf_f(1.0f), sse2_vmla_vf_vf_vf_vf(sse2_vmul_vf_vf_vf(s, s), u, s));

  u = sse2_vldexp2_vf_vf_vi2(u, q);

  u = sse2_vreinterpret_vf_vm(sse2_vandnot_vm_vo32_vm(sse2_vlt_vo_vf_vf(d, sse2_vcast_vf_f(-104)), sse2_vreinterpret_vm_vf(u)));
  u = sse2_vsel_vf_vo_vf_vf(sse2_vlt_vo_vf_vf(sse2_vcast_vf_f(100), d), sse2_vcast_vf_f(SLEEF_INFINITYf), u);

  return u;
}

vfloat Sleef_redux_expf4_u10sse2(vfloat d) {
  vint2 q = sse2_vrint_vi2_vf(sse2_vmul_vf_vf_vf(d, sse2_vcast_vf_f(R_LN2f)));
  vfloat s, u;

  s = sse2_vmla_vf_vf_vf_vf(sse2_vcast_vf_vi2(q), sse2_vcast_vf_f(-L2Uf), d);
  s = sse2_vmla_vf_vf_vf_vf(sse2_vcast_vf_vi2(q), sse2_vcast_vf_f(-L2Lf), s);

  u = sse2_vcast_vf_f(0.000198527617612853646278381);
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.00139304355252534151077271));
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.00833336077630519866943359));
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.0416664853692054748535156));
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.166666671633720397949219));
  u = sse2_vmla_vf_vf_vf_vf(u, s, sse2_vcast_vf_f(0.5));

  u = sse2_vadd_vf_vf_vf(sse2_vcast_vf_f(1.0f), sse2_vmla_vf_vf_vf_vf(sse2_vmul_vf_vf_vf(s, s), u, s));

  u = sse2_vldexp2_vf_vf_vi2(u, q);

  return u;
}

#undef SLEEF_INFINITY
#undef SLEEF_INFINITYf
#undef R_LN2f
#undef L2Uf
#undef L2Lf
#undef INLINE
#undef vfloat
#undef vdouble
#undef vint
#undef vint2
#undef vmask
#undef vopmask
